<!DOCTYPE HTML>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Stog : Developing plugins</title>
<link href="http://zoggy.github.io/stog/style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="page">
<div class="navbar navbar-fixed-top">
<div class="navbar-inner">
<div class="container">


  <div class="nav-collapse">
    <ul class="nav">
    <li class="&lt;navbar-home/&gt;"><a href="http://zoggy.github.io/stog/index.html">Stog</a></li>
    <li class="&lt;navbar-install/&gt;"><a href="http://zoggy.github.io/stog/install.html">Installation</a></li>
    <li class="active"><a href="http://zoggy.github.io/stog/doc.html">Documentation</a></li>
    <li class="&lt;navbar-plugins/&gt;"><a href="http://zoggy.github.io/stog/plugins.html">Plugins</a></li>
    <li class="&lt;navbar-blog/&gt;"><a href="http://zoggy.github.io/stog/blog.html">Blog</a></li>
    <li class="&lt;navbar-about/&gt;"><a href="http://zoggy.github.io/stog/about.html">?</a></li>
  </ul>
  <div class="nav pull-right">  </div>
  </div>

</div>
</div>
</div>

<div id="header">
  
  
  <div class="page-title">Developing plugins</div>
</div>




<p>
Plugins are written in OCaml. The compiled OCaml code is then
loaded in Stog with the <span class="icode">--plugin</span> or <span class="icode">--package</span>
options of <span class="icode">stog</span> (see <a href="http://zoggy.github.io/stog/running.html">Running Stog</a>).
</p>
<p>
A plugin can register new base rules and new modules.
</p>

<ul class="toc"><li class="toc-section"><a href="http://zoggy.github.io/stog/writing_plugins.html#baserules">Registering base rules</a></li><li class="toc-section"><a href="http://zoggy.github.io/stog/writing_plugins.html#modules">Registering modules</a></li><li class="toc-section"><a href="http://zoggy.github.io/stog/writing_plugins.html#compiling">Compilation</a></li><li class="toc-section"><a href="http://zoggy.github.io/stog/writing_plugins.html#using">Using</a></li></ul>
<div class="section"><div class="section-title" id="baserules">Registering base rules</div>
<p>
A plugin can add rewrite rules to the rules of function
<a href="http://zoggy.github.io/stog/module_base.html#base">base</a> of module <a href="http://zoggy.github.io/stog/module_base.html">Base</a>.
</p>
<p>
Here is an example:
</p>
<pre class="code-ocaml"><span class="hl com">(** Stog plugin example. *)</span>

<span class="hl kwa">let</span> fun_list stog env args subs <span class="hl opt">=</span>
  <span class="hl com">(* get the optional sep attribute ... *)</span>
  <span class="hl kwa">let</span> sep <span class="hl opt">=</span> <span class="hl kwc">Xtmpl</span><span class="hl opt">.</span>opt_arg args <span class="hl opt">(</span><span class="hl str">&quot;&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;sep&quot;</span><span class="hl opt">)</span> <span class="hl kwa">in</span>
  <span class="hl com">(* reverse the separator, for final list will be reversed *)</span>
  <span class="hl kwa">let</span> sep <span class="hl opt">=</span> <span class="hl kwc">List</span><span class="hl opt">.</span>rev sep <span class="hl kwa">in</span>
  <span class="hl com">(* then insert the separator between all children of the node *)</span>
  <span class="hl kwa">let rec</span> iter acc <span class="hl opt">=</span> <span class="hl kwa">function</span>
    <span class="hl opt">[] -&gt;</span> <span class="hl kwc">List</span><span class="hl opt">.</span>rev acc
  | h <span class="hl opt">::</span> q <span class="hl opt">-&gt;</span>
      <span class="hl kwa">let</span> acc <span class="hl opt">=</span>
        <span class="hl kwa">match</span> acc <span class="hl kwa">with</span>
          <span class="hl opt">[] -&gt; [</span>h<span class="hl opt">]</span>
        | _ <span class="hl opt">-&gt;</span> h <span class="hl opt">::</span> sep @ acc
      <span class="hl kwa">in</span>
      iter acc q
  <span class="hl kwa">in</span>
  <span class="hl com">(* and finally return the list of xml trees *)</span>
  <span class="hl opt">(</span>stog<span class="hl opt">,</span> iter <span class="hl opt">[]</span> subs<span class="hl opt">)</span>
<span class="hl opt">;;</span>

<span class="hl com">(* register the new function, associated to tag &quot;list&quot;.</span>
<span class="hl com">  Before stog 0.3, this function was called [Stog_plug.register_fun]. *)</span>
<span class="hl kwa">let</span> <span class="hl opt">() =</span> <span class="hl kwc">Stog_plug</span><span class="hl opt">.</span>register_html_base_rule <span class="hl opt">(</span><span class="hl str">&quot;&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;list&quot;</span><span class="hl opt">)</span> fun_list<span class="hl opt">;;</span></pre>
<p>
Have a look at the <a href="http://zoggy.github.io/stog/ref-doc">Stog library reference documentation</a>.
</p>
</div>

<div class="section"><div class="section-title" id="modules">Registering modules</div>
<p>
A plugin can also register a complete module, with named functions
associated to levels. These levels can also be specified in
the <code>.stog/config</code> file as explained
<a href="http://zoggy.github.io/stog/funs.html#config_funs">here</a>.
</p>
<p>An example of such a plugin is
<span class="ext-a"><a href="https://github.com/zoggy/stog/blob/master/plugins/stog_multi_elt.ml">stog_multi_elt</a></span>.
</p>
</div>

<div class="section"><div class="section-title" id="compiling">Compilation</div>
<div id="codecompilation">
<p>
The plugin is simply compiled with
</p>
<pre class="code-sh">ocamlfind ocamlopt <span class="hl opt">-</span>package stog <span class="hl opt">-</span>rectypes <span class="hl opt">-</span>shared <span class="hl opt">-</span>o plugin_example.cmxs plugin_example.ml</pre>
<p>
for native code or
</p>
<pre class="code-sh">ocamlfind ocamlc <span class="hl opt">-</span>package stog <span class="hl opt">-</span>rectypes <span class="hl opt">-</span>c plugin_example.ml</pre>
<p>for bytecode.</p>
</div>
</div>

<div class="section"><div class="section-title" id="using">Using</div>
<div id="usingcode">
<p>
The plugin is used by specifying it on the <span class="icode">stog</span> command line:
</p>
<pre class="code-sh">stog <span class="hl opt">--</span>plugin plugin_example.cmxs ...</pre>
<p>or, if the plugin is installed with ocamlfind:</p>
<pre class="code-sh">stog <span class="hl opt">--</span>package plugin_example ...</pre>
</div>
<p>
With our plugin example registering just a base rule, we can use the new &quot;list&quot;:
</p>
<pre class="code-xml"><span class="hl kwa">&lt;list</span> <span class="hl kwb">sep</span>=<span class="hl str">&quot;&amp;lt;b&amp;gt; -- &amp;lt;/b&amp;gt;&quot;</span><span class="hl kwa">&gt;&lt;span&gt;</span>first thing<span class="hl kwa">&lt;/span&gt;</span>second thing<span class="hl kwa">&lt;div&gt;</span>something else<span class="hl kwa">&lt;/div&gt;&lt;/list&gt;</span></pre>
<p>
This will be evaluated (reduced) to
</p>
<pre class="code-xml"><span class="hl kwa">&lt;span&gt;</span>first thing<span class="hl kwa">&lt;/span&gt;&lt;b&gt;</span> -- <span class="hl kwa">&lt;/b&gt;</span>second thing<span class="hl kwa">&lt;b&gt;</span> -- <span class="hl kwa">&lt;/b&gt;&lt;div&gt;</span>something else<span class="hl kwa">&lt;/div&gt;</span></pre>
</div>








<p class="alert alert-info">
For information you can see the <a href="#pagesource"> source code of the page</a>.
</p>
<div id="pagesource">
  <pre class="code-xml"><span class="hl kwa">&lt;page</span> <span class="hl kwb">title</span>=<span class="hl str">&quot;Developing plugins&quot;</span>
<span class="hl kwb">navbar-doc</span>=<span class="hl str">&quot;active&quot;</span>
<span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
Plugins are written in OCaml. The compiled OCaml code is then
loaded in Stog with the <span class="hl kwa">&lt;icode&gt;</span>--plugin<span class="hl kwa">&lt;/icode&gt;</span> or <span class="hl kwa">&lt;icode&gt;</span>--package<span class="hl kwa">&lt;/icode&gt;</span>
options of <span class="hl kwa">&lt;icode&gt;</span>stog<span class="hl kwa">&lt;/icode&gt;</span> (see <span class="hl kwa">&lt;page</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;running&quot;</span><span class="hl kwa">/&gt;</span>).
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
A plugin can register new base rules and new modules.
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;prepare-toc&gt;</span>
<span class="hl kwa">&lt;toc/&gt;</span>
<span class="hl kwa">&lt;section</span> <span class="hl kwb">id</span>=<span class="hl str">&quot;baserules&quot;</span> <span class="hl kwb">title</span>=<span class="hl str">&quot;Registering base rules&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
A plugin can add rewrite rules to the rules of function
<span class="hl kwa">&lt;elt</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;module_base#base&quot;</span><span class="hl kwa">/&gt;</span> of module <span class="hl kwa">&lt;elt</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;module_base&quot;</span><span class="hl kwa">&gt;</span>Base<span class="hl kwa">&lt;/elt&gt;</span>.
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
Here is an example:
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;hcode</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;ocaml&quot;</span> <span class="hl kwb">defer_</span>=<span class="hl str">&quot;1&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;include</span> <span class="hl kwb">file</span>=<span class="hl str">&quot;../plugins/plugin_example.ml&quot;</span> <span class="hl kwb">raw</span>=<span class="hl str">&quot;true&quot;</span><span class="hl kwa">/&gt;</span>
<span class="hl kwa">&lt;/hcode&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
Have a look at the <span class="hl kwa">&lt;elt</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;/ref-doc/index&quot;</span><span class="hl kwa">/&gt;</span>.
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;/section&gt;</span>

<span class="hl kwa">&lt;section</span> <span class="hl kwb">id</span>=<span class="hl str">&quot;modules&quot;</span> <span class="hl kwb">title</span>=<span class="hl str">&quot;Registering modules&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
A plugin can also register a complete module, with named functions
associated to levels. These levels can also be specified in
the <span class="hl kwa">&lt;code&gt;</span>.stog/config<span class="hl kwa">&lt;/code&gt;</span> file as explained
<span class="hl kwa">&lt;elt</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;funs#config_funs&quot;</span><span class="hl kwa">&gt;</span>here<span class="hl kwa">&lt;/elt&gt;</span>.
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>An example of such a plugin is
<span class="hl kwa">&lt;ext-a</span> <span class="hl kwb">href</span>=<span class="hl str">&quot;https://github.com/zoggy/stog/blob/master/plugins/stog_multi_elt.ml&quot;</span><span class="hl kwa">&gt;</span>stog_multi_elt<span class="hl kwa">&lt;/ext-a&gt;</span>.
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;/section&gt;</span>

<span class="hl kwa">&lt;section</span> <span class="hl kwb">id</span>=<span class="hl str">&quot;compiling&quot;</span> <span class="hl kwb">title</span>=<span class="hl str">&quot;Compilation&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;div</span> <span class="hl kwb">id</span>=<span class="hl str">&quot;codecompilation&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
The plugin is simply compiled with
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;command-line&gt;</span>ocamlfind ocamlopt -package stog -rectypes -shared -o plugin_example.cmxs plugin_example.ml<span class="hl kwa">&lt;/command-line&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
for native code or
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;command-line&gt;</span>ocamlfind ocamlc -package stog -rectypes -c plugin_example.ml<span class="hl kwa">&lt;/command-line&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>for bytecode.<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;/div&gt;</span>
<span class="hl kwa">&lt;/section&gt;</span>

<span class="hl kwa">&lt;section</span> <span class="hl kwb">id</span>=<span class="hl str">&quot;using&quot;</span> <span class="hl kwb">title</span>=<span class="hl str">&quot;Using&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;div</span> <span class="hl kwb">id</span>=<span class="hl str">&quot;usingcode&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
The plugin is used by specifying it on the <span class="hl kwa">&lt;icode&gt;</span>stog<span class="hl kwa">&lt;/icode&gt;</span> command line:
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;command-line&gt;</span>stog --plugin plugin_example.cmxs ...<span class="hl kwa">&lt;/command-line&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>or, if the plugin is installed with ocamlfind:<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;command-line&gt;</span>stog --package plugin_example ...<span class="hl kwa">&lt;/command-line&gt;</span>
<span class="hl kwa">&lt;/div&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
With our plugin example registering just a base rule, we can use the new <span class="hl str">&quot;list&quot;</span>:
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;hcode</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;xml&quot;</span><span class="hl kwa">&gt;</span>&lt;![CDATA[
<span class="hl kwa">&lt;list</span> <span class="hl kwb">sep</span>=<span class="hl str">&quot;&amp;lt;b&amp;gt; -- &amp;lt;/b&amp;gt;&quot;</span><span class="hl kwa">&gt;&lt;span&gt;</span>first thing<span class="hl kwa">&lt;/span&gt;</span>second thing<span class="hl kwa">&lt;div&gt;</span>something else<span class="hl kwa">&lt;/div&gt;&lt;/list&gt;</span>]]<span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;/hcode&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
This will be evaluated (reduced) to
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;hcode</span> <span class="hl kwb">defer_</span>=<span class="hl str">&quot;1&quot;</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;xml&quot;</span><span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;list</span> <span class="hl kwb">sep</span>=<span class="hl str">&quot;&amp;lt;b&amp;gt; -- &amp;lt;/b&amp;gt;&quot;</span><span class="hl kwa">&gt;&lt;span&gt;</span>first thing<span class="hl kwa">&lt;/span&gt;</span>second thing<span class="hl kwa">&lt;div&gt;</span>something else<span class="hl kwa">&lt;/div&gt;&lt;/list&gt;</span>
<span class="hl kwa">&lt;/hcode&gt;</span>
<span class="hl kwa">&lt;/section&gt;</span>

<span class="hl com">&lt;!--</span>
<span class="hl com">&lt;section id=&quot;cache&quot; title=&quot;Keeping the cache system in the loop&quot;&gt;</span>
<span class="hl com">&lt;p&gt;</span>
<span class="hl com">The cache system (see &lt;elt href=&quot;running&quot;/&gt;) must be aware</span>
<span class="hl com">of dependencies of each element on other elements and files.</span>
<span class="hl com">&lt;/p&gt;</span>
<span class="hl com">&lt;p&gt;</span>
<span class="hl com">If a new rule defined by a plugin uses a file or implies a dependency</span>
<span class="hl com">from an element to another, this rule must declare this dependency</span>
<span class="hl com">using the &lt;elt href=&quot;Stog_plug#VALadd_dep&quot;&gt;&lt;code&gt;Stog_plug.add_dep&lt;/code&gt;&lt;/elt&gt; function:</span>
<span class="hl com">&lt;/p&gt;</span>
<span class="hl com">&lt;ocaml&gt;Stog_plug.add_dep : Stog_types.elt -&gt; dependency -&gt; unit&lt;/ocaml&gt;</span>
<span class="hl com">&lt;p&gt;</span>
<span class="hl com">If a plugin computes information which could be cached, it can declare a</span>
<span class="hl com">new cache for this informations, using the</span>
<span class="hl com">&lt;elt href=&quot;Stog_plug#VALregister_cache&quot;&gt;&lt;code&gt;Stog_plug.register_cache&lt;/code&gt;&lt;/elt&gt; function:</span>
<span class="hl com">&lt;/p&gt;</span>
<span class="hl com">&lt;ocaml&gt;val register_cache : (module Stog_cache.Cache) -&gt; unit&lt;/ocaml&gt;</span>
<span class="hl com">&lt;p&gt;</span>
<span class="hl com">The Cache module to provide is very simple; have a look at the</span>
<span class="hl com">&lt;elt href=&quot;Stog_cache.Cache&quot;&gt;&lt;code&gt;Stog_cache.Cache&lt;/code&gt;&lt;/elt&gt;module type.</span>
<span class="hl com">&lt;/p&gt;</span>
<span class="hl com">&lt;/section&gt;</span>
<span class="hl com">--&gt;</span>
<span class="hl kwa">&lt;/prepare-toc&gt;</span>
<span class="hl kwa">&lt;/page&gt;</span></pre>
</div>


<script src="http://zoggy.github.io/stog/jquery.js" type="text/javascript">_</script>
<script src="http://zoggy.github.io/stog/bootstrap-collapse.js" type="text/javascript">_</script>

</div> 
</body>
</html>