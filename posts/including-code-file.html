<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Stog : Including a code file (deferring evaluation)</title>
<link rel="stylesheet" type="text/css" href="http://zoggy.github.io/stog/style.css"/>
</head>
<body>
<div id="page">
<div class="navbar navbar-fixed-top">
<div class="navbar-inner">
<div class="container">


  <ul class="nav">
    <li class="&lt;navbar-home/&gt;"><a href="http://zoggy.github.io/stog/index.html">Stog</a></li>
    <li class="&lt;navbar-install/&gt;"><a href="http://zoggy.github.io/stog/install.html">Installation</a></li>
    <li class="&lt;navbar-doc/&gt;"><a href="http://zoggy.github.io/stog/doc.html">Documentation</a></li>
    <li class="&lt;navbar-plugins/&gt;"><a href="http://zoggy.github.io/stog/plugins.html">Plugins</a></li>
    <li class="active"><a href="http://zoggy.github.io/stog/blog.html">Blog</a></li>
    <li class="&lt;navbar-about/&gt;"><a href="http://zoggy.github.io/stog/about.html">?</a></li>
  </ul>
  <div class="nav pull-right">


  </div>

</div>
</div>
</div>

<div id="header">
  
  <div class="elt-navbar">
      <div class="navleft"><a href="http://zoggy.github.io/stog/posts/displaying-evaluated-ocaml-code.html">Displaying evaluated OCaml code</a></div>
      <div class="navright"><a href="http://zoggy.github.io/stog/posts/release-0.1.html">Stog 0.1</a></div>
    </div>
  <div class="page-title">Including a code file (deferring evaluation)</div>
</div>

<div class="date">March 13, 2012</div>


<p>How to highlight a file inserted with <span class="icode"><span class="hl kwa">&lt;include</span> ...<span class="hl kwa">&gt;</span></span> ?
</p>

<p>
If you want to include and highlight for example the <span class="icode">../plugins/stog_disqus.ml</span> file
relative to your project directory, you can try
<pre class="code-xml"><span class="hl kwa">&lt;hcode</span> <span class="hl kwb">raw</span>=<span class="hl str">&quot;true&quot;</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;ocaml&quot;</span><span class="hl kwa">&gt;&lt;include</span> <span class="hl kwb">file</span>=<span class="hl str">&quot;../plugins/stog_disqus.ml&quot;</span><span class="hl kwa">/&gt;&lt;/hcode&gt;</span></pre>
but this will only result in
<pre class="code-ocaml"><span class="hl opt">&lt;</span><span class="hl kwa">include</span> file<span class="hl opt">=</span><span class="hl str">&quot;../../plugins/stog_disqus.ml&quot;</span><span class="hl opt">/&gt;</span></pre>
</p>
<p>This is because <span class="icode">&lt;hcode...&gt;</span> is evaluated immediately, displaying
its children nodes. What you need is to defer the evaluation of <span class="icode">&lt;hcode...&gt;</span>,
using the special <span class="icode">defer_</span> attribute:
<pre class="code-xml"><span class="hl kwa">&lt;hcode</span> <span class="hl kwb">raw</span>=<span class="hl str">&quot;true&quot;</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;ocaml&quot;</span> <span class="hl kwb">defer_</span>=<span class="hl str">&quot;1&quot;</span><span class="hl kwa">&gt;&lt;include</span> <span class="hl kwb">file</span>=<span class="hl str">&quot;../plugins/stog_disqus.ml&quot;</span><span class="hl kwa">/&gt;&lt;/hcode&gt;</span></pre>
This will give the expected result:
<pre class="code-ocaml"><span class="hl kwa">open</span> <span class="hl kwd">Stog_types</span><span class="hl opt">;;</span>

<span class="hl kwa">let</span> fun_comments env args subs <span class="hl opt">=</span>
  <span class="hl kwa">let</span> stog <span class="hl opt">=</span> <span class="hl kwc">Stog_plug</span><span class="hl opt">.</span>stog <span class="hl opt">()</span> <span class="hl kwa">in</span>
  <span class="hl kwa">let</span> tmpl <span class="hl opt">=</span> <span class="hl kwc">Filename</span><span class="hl opt">.</span>concat stog<span class="hl opt">.</span>stog_tmpl_dir <span class="hl str">&quot;disqus.tmpl&quot;</span> <span class="hl kwa">in</span>
  <span class="hl kwc">Xtmpl</span><span class="hl opt">.</span>apply_to_file env tmpl
<span class="hl opt">;;</span>

<span class="hl kwa">let</span> <span class="hl opt">() =</span> <span class="hl kwc">Stog_plug</span><span class="hl opt">.</span>register_rule <span class="hl opt">(</span><span class="hl str">&quot;&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;comments&quot;</span><span class="hl opt">)</span> fun_comments<span class="hl opt">;;</span></pre>
</p>
<p>
The <span class="icode">defer_</span> attribute is decremented each time the node should be evaluated.
So the first time, the value is 1, so the children are evaluated first, then the
<span class="icode">&lt;hcode&gt;</span> node is returned with a <span class="icode">defer_</span> attribute
decremented, i.e. 0, and with the result of <span class="icode">&lt;include ...&gt;</span>
as children. During the next evaluation, the <span class="icode">&lt;hcode&gt;</span> is evaluated
and it now highlights its children, that is the contents of the included file.
</p>
<p><span class="icode">defer_</span> can take values greater than 1, if you need to nest deferred evaluations.</p>


<div class="comments">
  <div>
    <div class="elt-keywords">
      <div class="bloc-keywords">
      Topics: <div class="keywords"><a href="http://zoggy.github.io/stog/topic_stog.html"><span itemprop="keywords">stog</span></a></div>
      </div>
      <div class="bloc-keywords">
      Keywords: <div class="keywords"><a href="http://zoggy.github.io/stog/kw_highlight.html"><span itemprop="keywords">highlight</span></a>,<a href="http://zoggy.github.io/stog/kw_include.html"><span itemprop="keywords">include</span></a>,<a href="http://zoggy.github.io/stog/kw_code.html"><span itemprop="keywords">code</span></a></div>
      </div>
    </div>
  </div>
  <div itemprop="articleSection" class="section">
    <div id="disqus_thread"> </div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'stog'; // required: replace example with your forum shortname
    var disqus_url = 'http://zoggy.github.io/stog/posts/including-code-file.html' ;
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  </div>
 </div>



<p class="alert alert-info">
For information you can see the <a href="#pagesource"> source code of the page</a>.
</p>
<div id="pagesource">
  <pre class="code-xml"><span class="hl kwa">&lt;post</span> <span class="hl kwb">title</span>=<span class="hl str">&quot;Including a code file (deferring evaluation)&quot;</span>
<span class="hl kwb">date</span>=<span class="hl str">&quot;2012/03/13&quot;</span>
<span class="hl kwb">topics</span>=<span class="hl str">&quot;stog&quot;</span>
<span class="hl kwb">keywords</span>=<span class="hl str">&quot;highlight, include, code&quot;</span>
<span class="hl kwb">published</span>=<span class="hl str">&quot;true&quot;</span>
<span class="hl kwa">&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>How to highlight a file inserted with <span class="hl kwa">&lt;icode</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;xml&quot;</span><span class="hl kwa">&gt;</span><span class="hl kwd">&amp;lt;</span>include ...<span class="hl kwd">&amp;gt;</span><span class="hl kwa">&lt;/icode&gt;</span> ?
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;sep_/&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
If you want to include and highlight for example the <span class="hl kwa">&lt;icode&gt;</span>../plugins/stog_disqus.ml<span class="hl kwa">&lt;/icode&gt;</span> file
relative to your project directory, you can try
<span class="hl kwa">&lt;hcode</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;xml&quot;</span><span class="hl kwa">&gt;</span>&lt;![CDATA[<span class="hl kwa">&lt;hcode</span> <span class="hl kwb">raw</span>=<span class="hl str">&quot;true&quot;</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;ocaml&quot;</span><span class="hl kwa">&gt;&lt;include</span> <span class="hl kwb">file</span>=<span class="hl str">&quot;../plugins/stog_disqus.ml&quot;</span><span class="hl kwa">/&gt;&lt;/hcode&gt;</span>]]<span class="hl kwa">&gt;&lt;/hcode&gt;</span>
but this will only result in
<span class="hl kwa">&lt;hcode</span> <span class="hl kwb">raw</span>=<span class="hl str">&quot;true&quot;</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;ocaml&quot;</span><span class="hl kwa">&gt;&lt;include</span> <span class="hl kwb">file</span>=<span class="hl str">&quot;../../plugins/stog_disqus.ml&quot;</span><span class="hl kwa">/&gt;&lt;/hcode&gt;</span>
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>This is because <span class="hl kwa">&lt;icode&gt;</span><span class="hl kwd">&amp;lt;</span>hcode...<span class="hl kwd">&amp;gt;</span><span class="hl kwa">&lt;/icode&gt;</span> is evaluated immediately, displaying
its children nodes. What you need is to defer the evaluation of <span class="hl kwa">&lt;icode&gt;</span><span class="hl kwd">&amp;lt;</span>hcode...<span class="hl kwd">&amp;gt;</span><span class="hl kwa">&lt;/icode&gt;</span>,
using the special <span class="hl kwa">&lt;icode&gt;</span>defer_<span class="hl kwa">&lt;/icode&gt;</span> attribute:
<span class="hl kwa">&lt;hcode</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;xml&quot;</span><span class="hl kwa">&gt;</span>&lt;![CDATA[<span class="hl kwa">&lt;hcode</span> <span class="hl kwb">raw</span>=<span class="hl str">&quot;true&quot;</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;ocaml&quot;</span> <span class="hl kwb">defer_</span>=<span class="hl str">&quot;1&quot;</span><span class="hl kwa">&gt;&lt;include</span> <span class="hl kwb">file</span>=<span class="hl str">&quot;../plugins/stog_disqus.ml&quot;</span><span class="hl kwa">/&gt;&lt;/hcode&gt;</span>]]<span class="hl kwa">&gt;&lt;/hcode&gt;</span>
This will give the expected result:
<span class="hl kwa">&lt;hcode</span> <span class="hl kwb">raw</span>=<span class="hl str">&quot;true&quot;</span> <span class="hl kwb">lang</span>=<span class="hl str">&quot;ocaml&quot;</span> <span class="hl kwb">defer_</span>=<span class="hl str">&quot;1&quot;</span><span class="hl kwa">&gt;&lt;include</span> <span class="hl kwb">file</span>=<span class="hl str">&quot;../../plugins/stog_disqus.ml&quot;</span><span class="hl kwa">/&gt;&lt;/hcode&gt;</span>
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;p&gt;</span>
The <span class="hl kwa">&lt;icode&gt;</span>defer_<span class="hl kwa">&lt;/icode&gt;</span> attribute is decremented each time the node should be evaluated.
So the first time, the value is <span class="hl num">1</span>, so the children are evaluated first, then the
<span class="hl kwa">&lt;icode&gt;</span><span class="hl kwd">&amp;lt;</span>hcode<span class="hl kwd">&amp;gt;</span><span class="hl kwa">&lt;/icode&gt;</span> node is returned with a <span class="hl kwa">&lt;icode&gt;</span>defer_<span class="hl kwa">&lt;/icode&gt;</span> attribute
decremented, i.e. <span class="hl num">0</span>, and with the result of <span class="hl kwa">&lt;icode&gt;</span><span class="hl kwd">&amp;lt;</span>include ...<span class="hl kwd">&amp;gt;</span><span class="hl kwa">&lt;/icode&gt;</span>
as children. During the next evaluation, the <span class="hl kwa">&lt;icode&gt;</span><span class="hl kwd">&amp;lt;</span>hcode<span class="hl kwd">&amp;gt;</span><span class="hl kwa">&lt;/icode&gt;</span> is evaluated
and it now highlights its children, that is the contents of the included file.
<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;p&gt;&lt;icode&gt;</span>defer_<span class="hl kwa">&lt;/icode&gt;</span> can take values greater than <span class="hl num">1</span>, if you need to nest deferred evaluations.<span class="hl kwa">&lt;/p&gt;</span>
<span class="hl kwa">&lt;/post&gt;</span></pre>
</div>


</div> 
</body>
</html>