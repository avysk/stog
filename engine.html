<!DOCTYPE HTML>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Stog : Evaluation and templating</title>
<link href="https://zoggy.github.io/stog/style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="page">
<div class="navbar navbar-fixed-top">
<div class="navbar-inner">
<div class="container">


  <div class="nav-collapse">
    <ul class="nav">
    <li class="&lt;navbar-home/&gt;"><a href="https://zoggy.github.io/stog/index.html">Stog</a></li>
    <li class="&lt;navbar-install/&gt;"><a href="https://zoggy.github.io/stog/install.html">Installation</a></li>
    <li class="active"><a href="https://zoggy.github.io/stog/doc.html">Documentation</a></li>
    <li class="&lt;navbar-plugins/&gt;"><a href="https://zoggy.github.io/stog/plugins.html">Plugins</a></li>
    <li class="&lt;navbar-blog/&gt;"><a href="https://zoggy.github.io/stog/blog.html">Blog</a></li>
    <li class="&lt;navbar-about/&gt;"><a href="https://zoggy.github.io/stog/about.html">?</a></li>
  </ul>
  <div class="nav pull-right">  </div>
  </div>

</div>
</div>
</div>

<div id="header">
  
  
  
  <div class="page-title">Evaluation and templating</div>
</div>





<div class="section"><div class="section-title" id="howitworks">How it works</div>
<div class="float-right">
<a href="engine.svg">
<div class="img"><img alt="engine's big picture" class="img" src="engine.png" title="Data flow in Stog's engine. Click on the image to open the .svg file, which includes some links to reference documentation." width="350"/><div class="legend">
Data flow in Stog's engine.</div></div></a>
</div>
<p>
The figure on the side shows the global architecture of the
Stog engine and the flow of data.
</p>
<p><a href="https://zoggy.github.io/stog/stog-documents.html">Stog documents</a> are read from the source directory
and a <a href="https://zoggy.github.io/stog/ref-doc/Stog_types.html#TYPEstog">stog</a> structure is created.
Since some documents may be in the cache and do not need to be recomputed,
the small yellow boxes represent the filtering of documents in the stog
structure to create a list of documents to compute.
</p>
<p>
Two modules are represented on the figure (Module 1 and Module 2). More modules
can be present, for example when loading <a href="https://zoggy.github.io/stog/writing_plugins.html">plugins</a>.
</p>
<p>These modules define functions associated to <em>levels</em>: Here
the Module 1 has functions for levels 0, 20 and 30, while Module 2 has
functions for levels 1 and 20.
</p>
<p>For each level, in ascending order, the stog structure is passed
to the function at this level, for each module where there is one.
These functions take the stog structure and the list of documents
to compute. They return a new stog structure (which may be unchanged, if
no document was changed or created).
</p>
<p>These &quot;level functions&quot; also take in parameter a data structure which is
specific for each module. This data structure is also returned by the functions,
as in a regular &quot;fold&quot; function.
</p>
<p>
When the functions of all levels have been applied, the documents in the
final stog structure are outputted to files in the target directory, according
to their path in the source directory. The cache is updated with information
about dependencies and contents of documents. For each module, a specific
function is called to cache the final data associated to the module.
All cache information is stored in the <span class="icode"><span class="hl std">.stog/cache</span></span> directory.
</p>
<p>
The cached documents and dependencies will be used next time Stog is run,
to know which documents must be recomputed, and cached module data will
be used to initialize the data structure specific to each module.
</p>
<p>
Stog comes with two predefined modules, &quot;base&quot; and &quot;blocks&quot;, each defining
functions for various levels. The &quot;level functions&quot; often apply rewrite rules
on the documents' contents (which are XML trees) but can also perform other
actions like gathering information in the module-specific data structure
to use it in a higher level.
</p>
<p>Various levels are required to ensure some treatments or rewrite rules
will be applied after
others, for example to verify cross-document links. Levels used by predefined
modules are numbered like lines in BASIC programs: 0, 50, 100, 120, ... making
plugins able to insert new levels.
</p>
<p>Modules can define functions for negative levels, for example to make
sure they will be applied before level 0.
</p>
<p>The first application of a level function to a document uses the
type of the document to load the corresponding template; for example,
if the document has type &quot;page&quot;, then a template <span class="icode"><span class="hl std">page.tmpl</span></span> will
be looked for (in the <span class="icode"><span class="hl std">.stog/templates</span></span> directory).
</p>
</div>

<div class="section"><div class="section-title" id="env">Environment</div>
<p>An environment is built containing the
<a href="https://zoggy.github.io/stog/stog-main-document.html">site-wide attributes</a>.
This environment is a set of rewrite rules. It is passed to every &quot;level function&quot;.
</p>
<p>
A &quot;level function&quot; can enrich this environment with the attributes of a document
(using <a href="https://zoggy.github.io/stog/ref-doc/Stog_engine.html#VALdoc_env">this function</a>). This is what
most of the default level functions do, in addition to defining rewrite rules,
to get the &quot;rewrite environment&quot; to apply on each document to compute.
</p>
<p>
The environment is used in the following way to rewrite XML trees.
For each encountered node with tag <span class="icode"><span class="hl std">t</span></span>, <span class="icode"><span class="hl std">t</span></span> is looked up
in the environment for its associated <em>function</em> <span class="icode"><span class="hl std">f</span></span>.
</p>
<p>If no <span class="icode"><span class="hl std">f</span></span> is found, then the XML node is left untouched
and the children of the node are then analysed.
</p>
<p>If <span class="icode"><span class="hl std">f</span></span> is found, then it is called, given the environment,
the attributes and the children of the node. Then the function returns
a list of XML trees which must then be analysed.
</p>
<p>When this analyze reaches a fixpoint, the final XML is returned.
</p>
<p>This work is performed by the <span class="ext-a"><a href="https://github.com/zoggy/xtmpl">Xtmpl</a></span>
library.</p>
<p>Besides, the contents of the attributes are also analysed to perform such substitutions,
before looking up for the tag in the environment.
</p>
<p>Stog comes with <a href="https://zoggy.github.io/stog/funs.html">predefined functions</a> (in two default modules)
associated to some tags, but more can be created in
<a href="https://zoggy.github.io/stog/writing_plugins.html">plugins</a>.
</p>
</div>





<p class="alert alert-info">
For information you can see the <a href="#pagesource"> source code of the page</a>.
</p>
<div id="pagesource">
  <pre class="code-xml"><span class="hl kwa">&lt;page</span><span class="hl std"> </span><span class="">title</span><span class="hl std">=</span><span class="hl str">&quot;Evaluation and templating&quot;</span><span class="hl std">
</span><span class="">navbar-doc</span><span class="hl std">=</span><span class="hl str">&quot;active&quot;</span><span class="hl std">
</span><span class="hl kwa">&gt;</span><span class="hl std">

</span><span class="hl kwa">&lt;section</span><span class="hl std"> </span><span class="">id</span><span class="hl std">=</span><span class="hl str">&quot;howitworks&quot;</span><span class="hl std"> </span><span class="">title</span><span class="hl std">=</span><span class="hl str">&quot;How it works&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;div</span><span class="hl std"> </span><span class="">class</span><span class="hl std">=</span><span class="hl str">&quot;float-right&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;a</span><span class="hl std"> </span><span class="">href</span><span class="hl std">=</span><span class="hl str">&quot;engine.svg&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;image</span><span class="hl std"> </span><span class="">width</span><span class="hl std">=</span><span class="hl str">&quot;350&quot;</span><span class="hl std"> </span><span class="">src</span><span class="hl std">=</span><span class="hl str">&quot;engine.png&quot;</span><span class="hl std"> </span><span class="">alt</span><span class="hl std">=</span><span class="hl str">&quot;engine's big picture&quot;</span><span class="hl std">
</span><span class="">title</span><span class="hl std">=</span><span class="hl str">&quot;Data flow in Stog's engine.
 Click on the image to open the .svg file, which
includes some links to reference documentation.&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">
Data flow in Stog's engine.</span><span class="hl kwa">&lt;/image</span><span class="hl kwa">&gt;</span><span class="hl kwa">&lt;/a</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;/div</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">
The figure on the side shows the global architecture of the
Stog engine and the flow of data.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl kwa">&lt;doc</span><span class="hl std"> </span><span class="">href</span><span class="hl std">=</span><span class="hl str">&quot;stog-documents&quot;</span><span class="hl kwa">/&gt;</span><span class="hl std"> are read from the source directory
and a </span><span class="hl kwa">&lt;doc</span><span class="hl std"> </span><span class="">href</span><span class="hl std">=</span><span class="hl str">&quot;Stog_types#TYPEstog&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">stog</span><span class="hl kwa">&lt;/doc</span><span class="hl kwa">&gt;</span><span class="hl std"> structure is created.
Since some documents may be in the cache and do not need to be recomputed,
the small yellow boxes represent the filtering of documents in the stog
structure to create a list of documents to compute.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">
Two modules are represented on the figure (Module 1 and Module 2). More modules
can be present, for example when loading </span><span class="hl kwa">&lt;doc</span><span class="hl std"> </span><span class="">href</span><span class="hl std">=</span><span class="hl str">&quot;writing_plugins&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">plugins</span><span class="hl kwa">&lt;/doc</span><span class="hl kwa">&gt;</span><span class="hl std">.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">These modules define functions associated to </span><span class="hl kwa">&lt;em</span><span class="hl kwa">&gt;</span><span class="hl std">levels</span><span class="hl kwa">&lt;/em</span><span class="hl kwa">&gt;</span><span class="hl std">: Here
the Module 1 has functions for levels 0, 20 and 30, while Module 2 has
functions for levels 1 and 20.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">For each level, in ascending order, the stog structure is passed
to the function at this level, for each module where there is one.
These functions take the stog structure and the list of documents
to compute. They return a new stog structure (which may be unchanged, if
no document was changed or created).
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">These &quot;level functions&quot; also take in parameter a data structure which is
specific for each module. This data structure is also returned by the functions,
as in a regular &quot;fold&quot; function.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">
When the functions of all levels have been applied, the documents in the
final stog structure are outputted to files in the target directory, according
to their path in the source directory. The cache is updated with information
about dependencies and contents of documents. For each module, a specific
function is called to cache the final data associated to the module.
All cache information is stored in the </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">.stog/cache</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> directory.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">
The cached documents and dependencies will be used next time Stog is run,
to know which documents must be recomputed, and cached module data will
be used to initialize the data structure specific to each module.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">
Stog comes with two predefined modules, &quot;base&quot; and &quot;blocks&quot;, each defining
functions for various levels. The &quot;level functions&quot; often apply rewrite rules
on the documents' contents (which are XML trees) but can also perform other
actions like gathering information in the module-specific data structure
to use it in a higher level.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">Various levels are required to ensure some treatments or rewrite rules
will be applied after
others, for example to verify cross-document links. Levels used by predefined
modules are numbered like lines in BASIC programs: 0, 50, 100, 120, ... making
plugins able to insert new levels.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">Modules can define functions for negative levels, for example to make
sure they will be applied before level 0.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">The first application of a level function to a document uses the
type of the document to load the corresponding template; for example,
if the document has type &quot;page&quot;, then a template </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">page.tmpl</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> will
be looked for (in the </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">.stog/templates</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> directory).
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;/section</span><span class="hl kwa">&gt;</span><span class="hl std">

</span><span class="hl kwa">&lt;section</span><span class="hl std"> </span><span class="">id</span><span class="hl std">=</span><span class="hl str">&quot;env&quot;</span><span class="hl std"> </span><span class="">title</span><span class="hl std">=</span><span class="hl str">&quot;Environment&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">An environment is built containing the
</span><span class="hl kwa">&lt;doc</span><span class="hl std"> </span><span class="">href</span><span class="hl std">=</span><span class="hl str">&quot;stog-main-document&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">site-wide attributes</span><span class="hl kwa">&lt;/doc</span><span class="hl kwa">&gt;</span><span class="hl std">.
This environment is a set of rewrite rules. It is passed to every &quot;level function&quot;.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">
A &quot;level function&quot; can enrich this environment with the attributes of a document
(using </span><span class="hl kwa">&lt;doc</span><span class="hl std"> </span><span class="">href</span><span class="hl std">=</span><span class="hl str">&quot;Stog_engine#VALdoc_env&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">this function</span><span class="hl kwa">&lt;/doc</span><span class="hl kwa">&gt;</span><span class="hl std">). This is what
most of the default level functions do, in addition to defining rewrite rules,
to get the &quot;rewrite environment&quot; to apply on each document to compute.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">
The environment is used in the following way to rewrite XML trees.
For each encountered node with tag </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">t</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std">, </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">t</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> is looked up
in the environment for its associated </span><span class="hl kwa">&lt;em</span><span class="hl kwa">&gt;</span><span class="hl std">function</span><span class="hl kwa">&lt;/em</span><span class="hl kwa">&gt;</span><span class="hl std"> </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">f</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std">.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">If no </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">f</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> is found, then the XML node is left untouched
and the children of the node are then analysed.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">If </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">f</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> is found, then it is called, given the environment,
the attributes and the children of the node. Then the function returns
a list of XML trees which must then be analysed.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">When this analyze reaches a fixpoint, the final XML is returned.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">This work is performed by the </span><span class="hl kwa">&lt;ext-a</span><span class="hl std"> </span><span class="">href</span><span class="hl std">=</span><span class="hl str">&quot;https://github.com/zoggy/xtmpl&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">Xtmpl</span><span class="hl kwa">&lt;/ext-a</span><span class="hl kwa">&gt;</span><span class="hl std">
library.</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">Besides, the contents of the attributes are also analysed to perform such substitutions,
before looking up for the tag in the environment.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">Stog comes with </span><span class="hl kwa">&lt;page</span><span class="hl std"> </span><span class="">href</span><span class="hl std">=</span><span class="hl str">&quot;funs&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">predefined functions</span><span class="hl kwa">&lt;/page</span><span class="hl kwa">&gt;</span><span class="hl std"> (in two default modules)
associated to some tags, but more can be created in
</span><span class="hl kwa">&lt;doc</span><span class="hl std"> </span><span class="">href</span><span class="hl std">=</span><span class="hl str">&quot;writing_plugins&quot;</span><span class="hl kwa">&gt;</span><span class="hl std">plugins</span><span class="hl kwa">&lt;/doc</span><span class="hl kwa">&gt;</span><span class="hl std">.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;/section</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;/page</span><span class="hl kwa">&gt;</span><span class="hl std">
</span></pre>
</div>


<div id="footer">
<div class="generatedon">Generated on October 8, 2014 at 17h08</div>
</div>



</div> 
</body>
</html>